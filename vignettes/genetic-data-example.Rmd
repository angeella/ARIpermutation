---
author: "Angela Andreella"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::knitr}
  %\VignetteIndexEntry{Example using Genetic Datan}
  %\usepackage[UTF-8]{inputenc}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
#library(ARIpermutation)
#library(hommel)
library(ggplot2)
#library(cancerdata)
#library(dplyr)
#library(survival)
```

The data set VIJVER includes expression values of 24481 genes in 295 tumor samples. 

```{r, eval= F}
data(VIJVER1)
gene_expr <- exprs(VIJVER1) #Gene expression
gene_expr <- data.frame(t(data.frame(gene_expr) %>% drop_na()))

m <- dim(gene_expr)[2] 
n <- dim(gene_expr)[1] 

times <- VIJVER1$Follow_up_time_or_metastasis
events <- pmax(VIJVER1$event_metastasis, VIJVER1$event_death) 
pvalues <- matrix(nrow=100,ncol=m)

for(j in 2:100){
  ids <- sample(n)
  perm_times <- times[ids]
  perm_events <- events[ids]
  perm_surv <- Surv(time=perm_times, event=perm_events)
  pvalues[j,] <- sapply(c(1:m), function(x) summary(coxph(as.formula(paste("perm_surv ~ ", names(gene_expr)[x] )), data=gene_expr))$sctest[3],simplify = T)
}
surv <- Surv(time=times, event=events)
pvalues[1,] <- sapply(c(1:m), function(x) summary(coxph(as.formula(paste("surv ~ ", names(gene_expr)[x] )), data=gene_expr))$sctest[3],simplify = T)
```

So, we apply the method considering the full set of variables, i.e. genes:

```{r, eval= F}
alpha = 0.1
ix <- c(1:m)
out <- SingleStepCT(ix = ix, alpha = alpha, pvalues = t(pvalues))
out[[1]]
```

We have $698$ false null hypothesis. Using the hommel method by Goeman et al.:

```{r, eval= F}

praw <- pvalues[1,]
out1 <- hommel(praw)

discoveries(out1,ix,alpha = 0.1)
```

we have $566$ discoveries. So, we can note that we gain some power respect to the parametric method.

Then, we can see how this works considering different subset of hypothesis.

```{r, eval= F}
p_sort = sort(praw)
R = sapply(p_sort, function(t) sum(p_sort <=t)) 
#TD_permutation_genetic.RData: takes a lot to compute
out3 <- sapply(R, function(x) discoveriesPerm(out,ix = c(1:x))[[1]])
out4 <- sapply(R, function(x) discoveries(out1, ix = c(1:x), alpha = 0.1))
```

```{r}
load(system.file("extdata/vignettes_data", "TD_permutation_genetic.RData", package = "ARIpermutation"))
load(system.file("extdata/vignettes_data", "TD_parametric_genetic.RData", package = "ARIpermutation"))

ggplot() + ylim(0,0.2) +
   geom_line(aes(x = R, y = out4/pmax(1,R), colour = "Parametric"))+ 
   geom_line(aes(x = R, y = out3/pmax(1,R), colour = "Nonparametric")) +
   xlab(expression("|S|")) +
   ylab('TDP')  + theme(legend.title=element_blank())
```



