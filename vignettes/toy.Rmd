---
title: "Genetic Data example"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{toy}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(ARIpermutation)
library(Biobase) #for the dataset
library(cancerdata) #for the dataset
```

The data set VIJVER includes expression values of 24481 genes in 295 tumor samples. 

```{r}
data(VIJVER1)
X <- exprs(VIJVER1)
m <- dim(X)[2] #24481 variables
#Clean datasets from NA
X <- X[rowSums(is.na(X[ , 1:m])) == 0, ]
n <- dim(X)[2] #295 observations
m <- dim(X)[1] #24481 variables
ct = c(0,1)
alpha = 0.05
family = "Simes"
delta = 0
B = 200
```

So, we apply the method considering the full set of variables, i.e. genes:

```{r}
ix <- c(1:m)
out <- SingleStepCT(X,ct, ix, alpha, family, delta, B)

out[[1]]
```

We have $3334$ false null hypothesis. Using the hommel method by Goeman et al.:

```{r}
ix <- c(1:m)

res <- testByRandomization(X, B = 200)

praw <- res$p
out1 <- hommel(praw)

discoveries(out1,ix,alpha = 0.05)
```

we have $2634$ discoveries. So, we can note that we gain some power respect to the parametric method.

Then, we can see how this works considering different subset of hypothesis.

```{r}
p_sort = sort(praw)
R = sapply(p_sort, function(t) sum(p_sort <=t)) 

out3 <- sapply(R, function(x) discoveriesPerm(out,ix = c(1:x))[[1]])

out4 <- sapply(R, function(x) discoveries(out1, ix = c(1:x), alpha = 0.05))

plot(R, out4/pmax(1,R), type = "l", col = "black", lwd = 1)
lines(R, out3/pmax(1,R), type="l", col="red", lwd=2)

```

```{r}
plot(R, out3/out4, type='l')
```

check coverage

```{r}
Psort = rowSortC(t(res$p0))

sum( sapply(c(1:B), function(x) all(Psort[x,] >= out[[4]] )) )/B

```


