---
title: "Parametric vs NoParametric"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{simulation_analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r}
library(ARIpermutation)
library(hommel)
library(ggplot2)
m <- 1e3 #number of variables
n <- 20 #number of observations
pi0 <- 0.5 #Proportion of true null hypotheses
B <- 1e3 #number of permutation
rhos <- seq(-1,1,0.05) #Level of equi correlation between pairs of variables
SNR <-20 #Signal to noise ratio. 
alpha <- 0.1 #alpha level
delta <- seq(1,500,10)
delta <- 0
family = "Simes"
ct = c(0,1)
```

```{r}
simEC <- function(m,rho,n,pi0,SNR,B){
  
  X <-replicate(n,ARIpermutation::simulateData(pi0=pi0,m=m,rho = rho,SNR = SNR),simplify = TRUE)

  res <- ARIpermutation::signTest(X,B)
  Test <- cbind(res$Test,res$Test_H0)
  P <- cbind(res$pv,res$pv_H0)
  P <- t(P)
  Psort <- t(apply(P,1,sort))
  lambdaSimes <- ARIpermutation::lambdaOpt(pvalues = P,family = family,ct = ct,alpha = alpha,delta = 0)
  cvSimes <- ARIpermutation::cv(pvalues = Psort,family = family,alpha = alpha,lambda = lambdaSimes,ct = ct,delta = 0)
  out <- as.data.frame(cbind(cvSimes, res$pv, res$Test))
  colnames(out) <- c("CriticalValue", 
                     "Pvalues", "Test"
  )
  return(out)
}
```

```{r}

#out <- sapply(c(1:length(rhos)), function(x) simEC(m = m,rho = rhos[x],n = n,pi0 = pi0,SNR = SNR,B=B),simplify = FALSE)
load(system.file("extdata/vignettes_data", "out.RData", package = "ARIpermutation"))
cv <- sapply(c(1:length(rhos)), function(x) out[[x]]$CriticalValue)
Pvalues <- sapply(c(1:length(rhos)), function(x) out[[x]]$Pvalues)
Test <- sapply(c(1:length(rhos)), function(x) out[[x]]$Test)

m0 <- round(m * pi0)
m1 <- m - m0
H <- rep(c(0, 1), times = c(m0, m1))

discoveriesPerm <- sapply(c(1:length(rhos)), function(x) ARIpermutation::dI(ix = c(1:m),cv = cv[,x],praw = Pvalues[,x]))

discoveriesHommel <- sapply(c(1:length(rhos)), function(x) hommel::discoveries(hommel(Pvalues[,x]),ix = c(1:m),alpha = alpha))

True <- rep(sum(H==1),length(rhos))
ggplot() +
   geom_line(aes(x = rhos, y = discoveriesPerm, colour = "Nonparametric"))+ 
   geom_line(aes(x = rhos, y = discoveriesHommel, colour = "Parametric")) +
   geom_line(aes(x = rhos, y = True, colour = "True")) +
   xlab(expression(rho)) +
   ylab('number of True Discoveries')  + theme(legend.title=element_blank())

```

```{r}
id <- 15
p <- sort(Pvalues[,id])
R = sapply(p, function(t) sum(p <=t)) 
load(system.file("extdata/vignettes_data", "Bperm.RData", package = "ARIpermutation"))

#Bperm = sapply(1:length(p), function(i) i-ARIpermutation::dI(ix = c(1:i),cv = cv[,id],praw = Pvalues[,id]))       
Bpar = sapply(1:length(p), function(i) i-hommel::discoveries(hommel(Pvalues[,id], simes = TRUE), ix=1:i, alpha=alpha))

V <- c(rep(0,m1),seq(1,m0,1))

ggplot() +
   geom_line(aes(x = R, y = (R-Bpar)/pmax(1,R), colour = "Parametric TDP"))+ ylim(0,pi0+0.01) +
   geom_line(aes(x = R, y = (R-Bperm)/pmax(1,R), colour = "Permutation TDP")) +
  geom_line(aes(x = R, y = V/pmax(1,R), colour = "True TDP") )+
   xlab("Number of rejections") +
   ylab("True Discoveries Proportion") + ggtitle(expression(paste(rho, " = ", -0.3, sep = ""))) + theme(legend.title=element_blank())

```

```{r}
Test <- Test[,id]
data <- as.data.frame(cbind(Test,H))
colnames(data) <- c("Test", "Hyp")
data$Hyp <- ifelse(data$Hyp==0, "Null", "Alternative")
data$Hyp <- as.factor(data$Hyp)
ggplot(data,aes(x=c(1:m), y=Test, color=Hyp)) +
  geom_point() + ylab("Test") + xlab("Index hyp")

```

