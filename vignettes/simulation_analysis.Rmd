---
title: "Parametric vs NoParametric"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{simulation_analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r}
library(ARIpermutation)
library(hommel)
library(ggplot2)
m <- 2e3 #number of variables
n <- 20 #number of observations
pi0 <- 0.9 #Proportion of true null hypotheses
B <- 1e3 #number of permutation
rhos <- seq(0,1,0.05) #Level of equi correlation between pairs of variables
alpha <- 0.05 #alpha level
power <- 0.8
delta <- 0
family = "Simes"
```

```{r}
simEC <- function(m,rho,n,pi0,power,B, alpha){
  
  X <-simulateData(pi0,m,n, rho, power = power, alpha = alpha)
  X <- t(X)
  res <- signTest(X,B)
  Test <- cbind(res$Test,res$Test_H0)
  P <- cbind(res$pv,res$pv_H0)
  lambdaSimes <- ARIpermutation::lambdaOpt(pvalues = P,family = family,alpha = alpha,delta = 0)
  cvSimes <- ARIpermutation::cv(pvalues = P,family = family,alpha = alpha,lambda = lambdaSimes,delta = 0)
  out <- as.data.frame(cbind(cvSimes, res$pv, res$Test))
  colnames(out) <- c("CriticalValue", 
                     "Pvalues", "Test"
  )
  return(out)
}
```

```{r}
out <- sapply(c(1:length(rhos)), function(x) simEC(m = m,rho = rhos[x],n = n,pi0 = pi0,B=B, power = power, alpha = alpha),simplify = FALSE)
cv <- sapply(c(1:length(rhos)), function(x) out[[x]]$CriticalValue)
Pvalues <- sapply(c(1:length(rhos)), function(x) out[[x]]$Pvalues)
Test <- sapply(c(1:length(rhos)), function(x) out[[x]]$Test)

m0 <- round(m * pi0)
m1 <- m - m0
H <- rep(c(0, 1), times = c(m0, m1))

discoveriesPerm <- sapply(c(1:length(rhos)), function(x) ARIpermutation::dI(ix = c(1:m),cv = cv[,x],praw = Pvalues[,x]))

discoveriesHommel <- sapply(c(1:length(rhos)), function(x) hommel::discoveries(hommel(Pvalues[,x]),ix = c(1:m),alpha = alpha))

True <- rep(sum(H==1),length(rhos))
ggplot() +
   geom_line(aes(x = rhos, y = discoveriesPerm, colour = "Nonparametric"))+ 
   geom_line(aes(x = rhos, y = discoveriesHommel, colour = "Parametric")) +
   geom_line(aes(x = rhos, y = True, colour = "True")) +
   xlab(expression(rho)) + theme_bw() +
   ylab(expression(bar(a)(S)))  + theme(legend.title=element_blank())

```

```{r}
id <- 1
Test <- Test[,id]
data <- as.data.frame(cbind(Test,H))
colnames(data) <- c("Test", "Hyp")
data$Hyp <- c(rep("Alternative", m1), rep("Null", m0))
data$Hyp <- as.factor(data$Hyp)
ggplot(data,aes(x=c(1:m), y=Test, color=Hyp)) +
  geom_point() + ylab("Test") + xlab("Index hyp")

```

